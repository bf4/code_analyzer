<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Code analyzer by flyerhzm</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Code analyzer</h1>
        <p class="header">code analyzer tool which is extracted from rails_best_practices</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/flyerhzm/code_analyzer/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/flyerhzm/code_analyzer/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/flyerhzm/code_analyzer">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/flyerhzm">flyerhzm</a></p>
      </header>
      <section>

<h3>Introduction</h3>

<p><a href="https://github.com/flyerhzm/code_analyzer">code_analyzer</a> gem is extracted from
<a href="https://github.com/railsbp/rails_best_practices">rails_best_practices</a>,
it's aim to provide a simple way to write a ruby code analyzer tool.</p>

<h3>Quick Start</h3>

<h5>1. create ruby file you want to analyze.</h5>

<p>Let's create a simple ruby file <code>test_class.rb</code>, its content is as follow.</p>

<pre><code>class TestClass
  # bad
  def TestClass.some_method
    # body omitted
  end

  # good
  def self.some_other_method
    # body omitted
  end
end
</code></pre>

<p>The code is picked from <a href="https://github.com/styleguide/ruby">github ruby styleguide</a>,
let's write a code analyzer script to detect bad style. <code>TestClass.some_method</code></p>

<h5>2. understand the corresponding sexp you need to analyze.</h5>

<p>code_analyzer is analyzing sexp which is generated by ruby ripper, you should have a basic idea of what sexp is.
I have built a website <a href="http://try-ripper.herokuapp.com/">try-ripper</a>, which helps you easily understand sexp.
Copy the source code of test_class.rb to "Ruby Code" textarea, and click "Convert" button,
then you will see the corresponding Ripper Result. The sexp for TestClass.some_method is</p>

<pre><code>s(:var_ref, s(:@const, "TestClass", s(1, 4)))</code></pre>

<p>and sexp for self.some_method is</p>

<pre><code>s(:var_ref, s(:@kw, "self", s(2, 4)))</code></pre>

<p>Be aware I only paste the difference here. As you can see, what we only need to do is to check all class method definitions (defs),
and check if the first child is var_ref with @const, if so, it is a bad style.</p>

<h5>3. add code_analyzer dependency</h5>

<p>add Gemfile</p>

<pre><code>source :rubygems

gem "code_analyzer"</code></pre>

<p>and run <code>bundle install</code>.</p>

<h5>4. write a checker to detect bad style.</h5>

<p>code_analyzer allows you easily write your own ruby code checker.</p>

<pre><code>class ClassMethodChecker < CodeAnalyzer::Checker
  interesting_files /.*\.rb/
  interesting_nodes :defs

  add_callback :start_defs do |node|
    if :var_ref == node[1].sexp_type && :@const == node[1][1].sexp_type
      add_warning "use self to define class method"
    end
  end
end</code></pre>

<p>It said ClassMethodChecker will check all ruby files, and check only class method definition,
if it's first child (without sexp_type) is var_ref with @const, add warning to say "use self to define class method".</p>

<h5>5. analyze ruby code with code_analyzer</h5>

<p>Now we are ready to analyze <code>test_class.rb</code> code.</p>

<pre><code>require 'code_analyzer'
require './class_method_checker'

filename = "test_class.rb"
content = File.read(filename)

checker = ClassMethodChecker.new
visitor = CodeAnalyzer::CheckingVisitor::Default.new(checkers: [checker])
visitor.check(filename, content)
checker.warnings.each { |warning| puts warning }<code></pre>

<p><code>CodeAnalyzer::CheckingVisitor::Default</code> is used to visit all sexp nodes,
here we register ClassMethodChecker in visitor, and check the <code>test_class.rb</code>,
then we will see the following output.</p>

<pre><code>test_class.rb:3 - use self to define class method</code></pre>

<p>Okay, we have finished a simple ruby code analyzer tool.
You can get the sample code <a href="https://github.com/flyerhzm/test_code_analyzer">here</a>.</p>

      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		          <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-34928922-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
